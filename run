#!/usr/bin/env nix-shell
#! nix-shell shell.nix -i bash
set -euo pipefail

sudo mkdir -p /etc/containers || true
sudo cp -a ~/.config/containers/* /etc/containers/ || true

nix-build container/
podman import result/tarball/nixos-system-*.tar.xz nixos-docker

eval $(ssh-agent)
container_id=$(podman run --cgroup-manager=cgroupfs --privileged --publish=2024:22 -it --detach nixos-docker /init)
function finish {
    podman kill "$container_id"
    podman rm -f "$container_id"
    kill "$SSH_AGENT_PID"
}
trap finish EXIT

while true; do
    podman exec -it "$container_id" /run/current-system/sw/bin/journalctl -f &
    sleep 1
    ps -p $! > /dev/null && break
done

chmod 600 ./snakeoil/id_ed25519
ssh-add ./snakeoil/id_ed25519

# Add host key to known hosts & wait for ssh availability
timeout=$(expr $(date +%s) + 60)
while true; do
    ssh -o StrictHostKeyChecking=accept-new root@127.0.0.1 -p 2024 true && break

    if test $(date +%s) -ge $timeout; then
        echo "Timeout starting container reached!"
        exit 1
    fi

    sleep 3
done

nixops create deployment/deployment.nix
nixops deploy
